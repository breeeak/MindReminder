# Epic 5: 系统集成与数据管理

**用户成果：** 用户享受桌面应用的原生体验，数据安全可靠，支持备份和导出

**覆盖需求：**
- FR50-FR56: 数据管理全部功能
- FR57-FR64: 系统集成全部功能
- FR65-FR72: 用户设置全部功能
- NFR-R1-R4: 可靠性需求
- NFR-S1-S4: 安全与隐私需求

---

## Story 5.1: 系统托盘集成

As a **学习者**,
I want **应用最小化到系统托盘**,
So that **应用不占用任务栏空间，但随时可用**.

**Acceptance Criteria:**

**Given** 应用已启动
**When** 用户点击窗口最小化按钮
**Then** 应用最小化到系统托盘（不在任务栏显示）
**And** 托盘图标显示应用Logo

**When** 用户点击托盘图标
**Then** 应用窗口恢复显示并置于前台

**When** 用户右键点击托盘图标
**Then** 显示上下文菜单：
- "打开MindReminder"
- "今日待复习 (X个)" → 点击打开复习页面
- "快速记录" → 打开快速记录窗口
- "退出"

**When** 有待复习任务时
**Then** 托盘图标显示徽章（数字）
**And** 徽章数字为今日待复习数量

**When** 用户点击"退出"
**Then** 应用完全关闭
**And** 托盘图标消失

**And** Windows和macOS平台托盘功能一致

---

## Story 5.2: 全局快捷键

As a **学习者**,
I want **通过全局快捷键快速打开应用**,
So that **我可以随时记录灵感，无需切换窗口**.

**Acceptance Criteria:**

**Given** 应用正在运行（前台或后台）
**When** 用户按下Ctrl/Cmd + Shift + M（Windows/macOS）
**Then** 应用窗口显示并置于前台
**And** 如果窗口已在前台，则最小化到托盘

**When** 用户按下Ctrl/Cmd + Shift + N
**Then** 打开"快速记录"小窗口（400×300px）
**And** 窗口始终置顶
**And** 焦点自动定位到标题输入框

**When** 用户在"快速记录"窗口按ESC
**Then** 窗口关闭（不保存）

**When** 用户在"快速记录"窗口按Ctrl/Cmd + Enter
**Then** 保存知识点并关闭窗口

**When** 用户在设置中自定义快捷键
**Then** 可以修改快捷键组合
**And** 系统检查快捷键冲突
**And** 如有冲突显示警告
**And** 保存后快捷键立即生效

---

## Story 5.3: 数据备份和恢复

As a **学习者**,
I want **自动备份数据并能手动导出**,
So that **我的学习数据安全可靠，不会丢失**.

**Acceptance Criteria:**

**Given** 应用每日运行
**When** 每天首次启动应用
**Then** 自动备份数据库文件
**And** 备份文件命名：`backup_YYYY-MM-DD.db`
**And** 备份存储位置：
- Windows: `%APPDATA%/MindReminder/backups/`
- macOS: `~/Library/Application Support/MindReminder/backups/`

**And** 保留最近7天的备份文件
**And** 自动删除7天前的旧备份

**When** 用户在设置中点击"立即备份"
**Then** 立即创建备份文件
**And** 显示"备份成功"提示和文件路径

**When** 用户点击"恢复备份"
**Then** 显示可用备份列表（按日期排序）
**And** 每个备份显示日期、文件大小、知识点数量预览
**And** 用户选择备份并确认
**And** 显示警告："恢复备份将覆盖当前数据"
**And** 用户确认后执行恢复
**And** 应用重启，加载备份数据

**When** 用户点击"导出数据"
**Then** 显示格式选择：JSON或CSV
**And** 用户选择保存位置
**And** 导出所有知识点和复习历史
**And** 显示"导出成功"提示

**When** 用户点击"导入数据"
**Then** 选择JSON/CSV文件
**And** 验证文件格式
**And** 显示预览：将导入X个知识点
**And** 用户确认后导入
**And** 导入完成后刷新界面

---

## Story 5.4: 用户设置中心

As a **学习者**,
I want **自定义应用的各项设置**,
So that **应用符合我的个人习惯和需求**.

**Acceptance Criteria:**

**Given** 用户打开设置页面
**When** 页面加载完成
**Then** 显示以下设置分类：

**复习设置：**
- 全局复习频率系数（滑块，0.5x-1.5x）
- 记忆标准天数（输入框，默认30天）
- 记忆标准评分（下拉，默认"记得还可以"）
- 长期抽查间隔（输入框，默认60天）

**提醒设置：**
- 启用每日提醒（开关）
- 提醒时间（时间选择器，支持多个时间）
- 提醒声音（开关）
- 提醒方式（通知/托盘闪烁）

**界面设置：**
- 主题（浅色/深色/自动）
- 字体大小（小/中/大）
- 默认视图（日历/列表/统计）

**系统设置：**
- 开机自启动（开关）
- 最小化到托盘（开关）
- 全局快捷键配置
- 数据存储位置（只读，显示路径）

**When** 用户修改任何设置
**Then** 实时保存到数据库
**And** 相关功能立即生效
**And** 部分设置需要重启应用（显示提示）

**When** 用户点击"恢复默认设置"
**Then** 显示确认对话框
**And** 确认后重置所有设置为默认值

---

## Story 5.5: 开机自启动和窗口状态

As a **学习者**,
I want **应用开机自启动并记住窗口状态**,
So that **使用体验流畅，无需每次手动调整**.

**Acceptance Criteria:**

**Given** 用户在设置中启用"开机自启动"
**When** 系统启动后
**Then** Windows: 应用添加到启动文件夹
**And** macOS: 应用添加到登录项
**And** 应用自动启动（最小化到托盘）

**When** 用户禁用"开机自启动"
**Then** 从系统启动项中移除

**Given** 用户调整窗口大小和位置
**When** 关闭应用
**Then** 保存窗口状态到本地存储：
- 窗口宽度
- 窗口高度
- 窗口位置（x, y）
- 当前视图
- 侧边栏展开/收起状态

**When** 下次启动应用
**Then** 恢复上次的窗口状态
**And** 如果上次位置超出屏幕范围，则居中显示
**And** 最小窗口尺寸：800×600

**When** 用户在设置中点击"重置窗口"
**Then** 窗口恢复默认尺寸和居中位置

---

## Story 5.6: 数据完整性和错误处理

As a **学习者**,
I want **应用崩溃后数据不丢失**,
So that **我的学习记录始终安全可靠**.

**Acceptance Criteria:**

**Given** 应用正在使用
**When** 应用意外崩溃或系统断电
**Then** 已保存到数据库的数据完整无损
**And** SQLite事务保证原子性

**When** 应用下次启动
**Then** 检查数据库完整性
**And** 如果发现损坏，尝试修复
**And** 修复失败时提示用户恢复备份
**And** 显示错误日志位置

**When** 数据库写入操作失败
**Then** 记录错误到日志文件
**And** 显示友好错误消息："保存失败，请重试"
**And** 不关闭编辑窗口，保留用户输入

**When** 应用启动时数据库文件缺失
**Then** 自动创建新数据库
**And** 执行初始化迁移
**And** 显示"欢迎使用"引导页面

**When** 导入数据格式错误
**Then** 显示具体错误："文件格式不正确，请检查"
**And** 不执行导入操作
**And** 记录错误详情到日志

**And** 所有错误日志包含：
- 时间戳
- 错误类型
- 错误消息
- 堆栈跟踪（开发模式）

---

## Epic 5 完成！

✅ **已创建6个Stories**
- Story 5.1: 系统托盘集成
- Story 5.2: 全局快捷键
- Story 5.3: 数据备份和恢复
- Story 5.4: 用户设置中心
- Story 5.5: 开机自启动和窗口状态
- Story 5.6: 数据完整性和错误处理

✅ **覆盖需求验证：**
- ✅ FR50: SQLite本地存储 → Story 1.2
- ✅ FR51-FR53: 数据导出导入（JSON/CSV） → Story 5.3
- ✅ FR54-FR55: 每日自动备份和手动备份 → Story 5.3
- ✅ FR56: 启动时验证数据完整性 → Story 5.6
- ✅ FR57-FR58: 系统托盘集成 → Story 5.1
- ✅ FR59-FR60: 全局快捷键 → Story 5.2
- ✅ FR61-FR62: 桌面通知 → Story 3.5, 4.5
- ✅ FR63-FR64: 开机自启动和窗口状态 → Story 5.5
- ✅ FR65-FR72: 用户设置全部功能 → Story 5.4
- ✅ NFR-R1-R2: 数据完整性和自动备份 → Story 5.3, 5.6
- ✅ NFR-R3-R4: 应用稳定性和算法准确性 → Story 5.6
- ✅ NFR-S1-S4: 完全本地存储和隐私保护 → Story 5.3, 5.4
